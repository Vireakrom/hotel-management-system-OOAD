using HotelManagementSystem.Models;
using HotelManagementSystem.BLL.Factories;
using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace HotelManagementSystem.DAL
{
    public class RoomRepository : IRepository<Room>
    {
        /// <summary>
        /// Insert a new room
        /// </summary>
        public int Insert(Room room)
        {
            string query = @"
                INSERT INTO Rooms (RoomNumber, RoomType, FloorNumber, Status, BasePrice, MaxOccupancy, Description)
                VALUES (@RoomNumber, @RoomType, @FloorNumber, @Status, @BasePrice, @MaxOccupancy, @Description);
                SELECT CAST(SCOPE_IDENTITY() AS INT);";

            using (SqlConnection conn = DatabaseManager.Instance.GetConnection())
            {
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@RoomNumber", room.RoomNumber);
                    cmd.Parameters.AddWithValue("@RoomType", room.RoomType);
                    cmd.Parameters.AddWithValue("@FloorNumber", room.FloorNumber);
                    cmd.Parameters.AddWithValue("@Status", room.Status);
                    cmd.Parameters.AddWithValue("@BasePrice", room.BasePrice);
                    cmd.Parameters.AddWithValue("@MaxOccupancy", room.MaxOccupancy);
                    cmd.Parameters.AddWithValue("@Description", room.Description ?? (object)DBNull.Value);

                    conn.Open();
                    int newId = (int)cmd.ExecuteScalar();
                    return newId;
                }
            }
        }

        /// <summary>
        /// Get room by ID
        /// </summary>
        public Room GetById(int id)
        {
            string query = "SELECT * FROM Rooms WHERE RoomId = @RoomId AND IsActive = 1";

            using (SqlConnection conn = DatabaseManager.Instance.GetConnection())
            {
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@RoomId", id);

                    conn.Open();
                    using (SqlDataReader reader = cmd.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            return MapReaderToRoom(reader);
                        }
                    }
                }
            }
            return null;
        }

        /// <summary>
        /// Get all active rooms
        /// </summary>
        public List<Room> GetAll()
        {
            List<Room> rooms = new List<Room>();
            string query = "SELECT * FROM Rooms WHERE IsActive = 1 ORDER BY RoomNumber";

            using (SqlConnection conn = DatabaseManager.Instance.GetConnection())
            {
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    conn.Open();
                    using (SqlDataReader reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            rooms.Add(MapReaderToRoom(reader));
                        }
                    }
                }
            }
            return rooms;
        }

        /// <summary>
        /// Update room
        /// </summary>
        public bool Update(Room room)
        {
            string query = @"
                UPDATE Rooms 
                SET RoomNumber = @RoomNumber,
                    RoomType = @RoomType,
                    FloorNumber = @FloorNumber,
                    Status = @Status,
                    BasePrice = @BasePrice,
                    MaxOccupancy = @MaxOccupancy,
                    Description = @Description,
                    ModifiedDate = GETDATE()
                WHERE RoomId = @RoomId";

            using (SqlConnection conn = DatabaseManager.Instance.GetConnection())
            {
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@RoomId", room.RoomId);
                    cmd.Parameters.AddWithValue("@RoomNumber", room.RoomNumber);
                    cmd.Parameters.AddWithValue("@RoomType", room.RoomType);
                    cmd.Parameters.AddWithValue("@FloorNumber", room.FloorNumber);
                    cmd.Parameters.AddWithValue("@Status", room.Status);
                    cmd.Parameters.AddWithValue("@BasePrice", room.BasePrice);
                    cmd.Parameters.AddWithValue("@MaxOccupancy", room.MaxOccupancy);
                    cmd.Parameters.AddWithValue("@Description", room.Description ?? (object)DBNull.Value);

                    conn.Open();
                    int rowsAffected = cmd.ExecuteNonQuery();
                    return rowsAffected > 0;
                }
            }
        }

        /// <summary>
        /// Soft delete room
        /// </summary>
        public bool Delete(int id)
        {
            string query = "UPDATE Rooms SET IsActive = 0, ModifiedDate = GETDATE() WHERE RoomId = @RoomId";

            using (SqlConnection conn = DatabaseManager.Instance.GetConnection())
            {
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@RoomId", id);

                    conn.Open();
                    int rowsAffected = cmd.ExecuteNonQuery();
                    return rowsAffected > 0;
                }
            }
        }

        /// <summary>
        /// Get available rooms by date range
        /// </summary>
        public List<Room> GetAvailableRooms(DateTime checkIn, DateTime checkOut)
        {
            List<Room> rooms = new List<Room>();
            string query = @"
                SELECT * FROM Rooms 
                WHERE IsActive = 1 
                AND Status = 'Available'
                AND RoomId NOT IN (
                    SELECT RoomId FROM Bookings 
                    WHERE Status IN ('Confirmed', 'CheckedIn')
                    AND (
                        (CheckInDate <= @CheckOut AND CheckOutDate >= @CheckIn)
                    )
                )
                ORDER BY RoomNumber";

            using (SqlConnection conn = DatabaseManager.Instance.GetConnection())
            {
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@CheckIn", checkIn);
                    cmd.Parameters.AddWithValue("@CheckOut", checkOut);

                    conn.Open();
                    using (SqlDataReader reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            rooms.Add(MapReaderToRoom(reader));
                        }
                    }
                }
            }
            return rooms;
        }

        /// <summary>
        /// Update room status
        /// </summary>
        public bool UpdateRoomStatus(int roomId, string status)
        {
            string query = "UPDATE Rooms SET Status = @Status, ModifiedDate = GETDATE() WHERE RoomId = @RoomId";

            using (SqlConnection conn = DatabaseManager.Instance.GetConnection())
            {
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@RoomId", roomId);
                    cmd.Parameters.AddWithValue("@Status", status);

                    conn.Open();
                    int rowsAffected = cmd.ExecuteNonQuery();
                    return rowsAffected > 0;
                }
            }
        }

        /// <summary>
        /// Helper method to map SqlDataReader to Room object
        /// </summary>
        private Room MapReaderToRoom(SqlDataReader reader)
        {
            string roomType = reader["RoomType"].ToString();
            Room room;

            // Create the appropriate concrete room type based on RoomType
            switch (roomType)
            {
                case "Single":
                    room = new SingleRoom();
                    break;
                case "Double":
                    room = new DoubleRoom();
                    break;
                case "Suite":
                    room = new SuiteRoom();
                    break;
                case "Deluxe":
                    room = new DeluxeRoom();
                    break;
                default:
                    throw new InvalidOperationException($"Unknown room type: {roomType}");
            }

            // Set properties from database
            room.RoomId = (int)reader["RoomId"];
            room.RoomNumber = reader["RoomNumber"].ToString();
            room.FloorNumber = (int)reader["FloorNumber"];
            room.Status = reader["Status"].ToString();
            room.BasePrice = (decimal)reader["BasePrice"];
            room.MaxOccupancy = (int)reader["MaxOccupancy"];
            room.Description = reader["Description"] != DBNull.Value ? reader["Description"].ToString() : null;
            room.CreatedDate = (DateTime)reader["CreatedDate"];
            room.ModifiedDate = reader["ModifiedDate"] != DBNull.Value ? (DateTime?)reader["ModifiedDate"] : null;

            return room;
        }
    }
}
